name: Export and encrypt secrets

on:
  workflow_dispatch:

jobs:
  export-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Import GPG public key
        run: |
          echo "${{ secrets.GPG_PUBLIC_KEY }}" | gpg --import

      # Stealth directory and file names
      - name: Create working directory and write values
        run: |
          WORKDIR="x7p9q2t4b1z8"
          OUTFILE="k3d9f1s8q4v2"

          mkdir -p "$WORKDIR"

          {
            echo "TINKERBELLADDR=${{ secrets.TINKERBELLADDR }}"
            echo "PI42ADDR=${{ secrets.PI42ADDR }}"
            echo "DOCKTOPUSADDR=${{ secrets.DOCKTOPUSADDR }}"
            echo "HELIOSADDR=${{ secrets.HELIOSADDR }}"
            echo "ZEROTIER_NETWORK_ID=${{ secrets.ZEROTIER_NETWORK_ID }}"
            echo "NASADDR=${{ secrets.NASADDR }}"
            echo "STREAMINGADDR=${{ secrets.STREAMINGADDR }}"
            echo "INFRA01ADDR=${{ secrets.INFRA01ADDR }}"
            echo "EDGEROUTERADDR=${{ secrets.EDGEROUTERADDR }}"
            echo "FRITZADDR=${{ secrets.FRITZADDR }}"
            echo "PI41ADDR=${{ secrets.PI41ADDR }}"
          } > "$WORKDIR/$OUTFILE"

      - name: Encrypt the file using GPG
        run: |
          WORKDIR="x7p9q2t4b1z8"
          OUTFILE="k3d9f1s8q4v2"
          ENCFILE="d9f3x1q7m2r4.gpg"

          gpg --output "$WORKDIR/$ENCFILE" \
              --encrypt --recipient "${{ secrets.GPG_RECIPIENT_EMAIL }}" \
              "$WORKDIR/$OUTFILE"

          # Destroy plaintext instantly
          shred -u "$WORKDIR/$OUTFILE"

      - name: Upload encrypted artifact
        uses: actions/upload-artifact@v4
        with:
          name: encrypted-bundle
          path: x7p9q2t4b1z8/d9f3x1q7m2r4.gpg
