name: Export encrypted repo secrets

on:
  workflow_dispatch:

jobs:
  export-encrypted-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Import GPG public key
        env:
          GPG_PUBLIC_KEY: ${{ secrets.GPG_PUBLIC_KEY }}
        run: |
          # Strip anything before the BEGIN line, then import non-interactively
          echo "$GPG_PUBLIC_KEY" \
            | sed -n '/-----BEGIN PGP PUBLIC KEY BLOCK-----/,$p' \
            | gpg --batch --import || true

          echo "Current public keys:"
          gpg --list-keys

      - name: Write values to stealth file
        env:
          TINKERBELLADDR: ${{ secrets.TINKERBELLADDR }}
          PI42ADDR: ${{ secrets.PI42ADDR }}
          DOCKTOPUSADDR: ${{ secrets.DOCKTOPUSADDR }}
          HELIOSADDR: ${{ secrets.HELIOSADDR }}
          ZEROTIER_NETWORK_ID: ${{ secrets.ZEROTIER_NETWORK_ID }}
          NASADDR: ${{ secrets.NASADDR }}
          STREAMINGADDR: ${{ secrets.STREAMINGADDR }}
          INFRA01ADDR: ${{ secrets.INFRA01ADDR }}
          EDGEROUTERADDR: ${{ secrets.EDGEROUTERADDR }}
          FRITZADDR: ${{ secrets.FRITZADDR }}
          PI41ADDR: ${{ secrets.PI41ADDR }}
        run: |
          WORKDIR="x7p9q2t4b1z8"
          OUTFILE="k3d9f1s8q4v2"

          mkdir -p "$WORKDIR"

          {
            echo "TINKERBELLADDR=$TINKERBELLADDR"
            echo "PI42ADDR=$PI42ADDR"
            echo "DOCKTOPUSADDR=$DOCKTOPUSADDR"
            echo "HELIOSADDR=$HELIOSADDR"
            echo "ZEROTIER_NETWORK_ID=$ZEROTIER_NETWORK_ID"
            echo "NASADDR=$NASADDR"
            echo "STREAMINGADDR=$STREAMINGADDR"
            echo "INFRA01ADDR=$INFRA01ADDR"
            echo "EDGEROUTERADDR=$EDGEROUTERADDR"
            echo "FRITZADDR=$FRITZADDR"
            echo "PI41ADDR=$PI41ADDR"
          } > "$WORKDIR/$OUTFILE"

      - name: Encrypt file with GPG
        env:
          GPG_RECIPIENT_ID: ${{ secrets.GPG_RECIPIENT_ID }}
        run: |
          WORKDIR="x7p9q2t4b1z8"
          OUTFILE="k3d9f1s8q4v2"
          ENCFILE="d9f3x1q7m2r4.gpg"

          gpg --batch --yes --trust-model always \
              --output "$WORKDIR/$ENCFILE" \
              --encrypt \
              --recipient "$GPG_RECIPIENT_ID" \
              "$WORKDIR/$OUTFILE"

          shred -u "$WORKDIR/$OUTFILE"

      - name: Upload encrypted bundle
        uses: actions/upload-artifact@v4
        with:
          name: encrypted-bundle
          path: x7p9q2t4b1z8/d9f3x1q7m2r4.gpg
